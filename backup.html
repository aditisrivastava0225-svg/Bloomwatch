<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Flower Explorer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; }
    #cesiumContainer { width:100%; height:100%; }

    #geocoderContainer {
      position:absolute; top:20px; left:20px; z-index:9999;
      background:white; padding:10px; border-radius:10px; 
      box-shadow:0 2px 10px rgba(0,0,0,0.2); width:300px;
    }

    #search {
      width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;
      font-size:15px; outline:none;
    }

    #results {
      max-height:300px; overflow:auto; margin-top:10px;
    }

    .flowerResult {
      padding:5px; cursor:pointer; border-bottom:1px solid #eee;
    }
    .flowerResult:hover { background:#eee; }

    #sidePanel {
      position:absolute; top:20px; right:20px; width:350px; max-height:600px; 
      overflow-y:auto; background:white; padding:15px; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.2); display:none; z-index:9999;
    }
  </style>
</head>
<body>
  <div id="geocoderContainer">
    <input type="text" id="search" placeholder="Search for a flower...">
    <div id="results"></div>
  </div>
  <div id="sidePanel"></div>
  <div id="cesiumContainer"></div>

  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjNTAwZTMyMC0yMzI5LTRkNTQtODU0MS0xNmVkMTdhY2NjMTQiLCJpZCI6MzQ3MTkzLCJpYXQiOjE3NTk1OTU4MjF9.LuVC_WFOM1-jENYq6DgqMYcLml3e9a8eXFGZDuVroBc';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false, timeline: false, fullscreenButton: false,
      vrButton: false, homeButton: false, infoBox: false,
      sceneModePicker: false, navigationHelpButton: false,
      baseLayerPicker: false, geocoder: false
    });

    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(0.0, 0.0, 20000000),
      orientation: { heading:0, pitch:Cesium.Math.toRadians(-90), roll:0 }
    });

    const searchInput = document.getElementById("search");
    const resultsDiv = document.getElementById("results");
    const sidePanel = document.getElementById("sidePanel");

    async function loadFlowers() {
      const response = await fetch('./flowers1.xlsx');
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet);
    }

    const flowers = await loadFlowers();
    let filtered = [];

    searchInput.addEventListener("input", e => {
      const query = e.target.value.toLowerCase();
      filtered = flowers.filter(f =>
        (f.Name || "").toLowerCase().includes(query) ||
        (f["Scientific Name"] || "").toLowerCase().includes(query) ||
        (f["Region(s) of Distribution"] || "").toLowerCase().includes(query) ||
        (f["Blooming Season"] || "").toLowerCase().includes(query)
      );

      resultsDiv.innerHTML = filtered.map(f => `
        <div class="flowerResult">ðŸŒ¸ ${f.Name} <br><small>${f["Region(s) of Distribution"]}</small></div>
      `).join("");
    });

    // Click result -> show side panel
    resultsDiv.addEventListener("click", event => {
      const target = event.target.closest(".flowerResult");
      if (!target) return;

      const index = Array.from(resultsDiv.children).indexOf(target);
      const f = filtered[index];
      if (!f) return;

      sidePanel.innerHTML = `
        <h2>${f.Name}</h2>
        <p><strong>Scientific Name:</strong> ${f["Scientific Name"]}</p>
        <p><strong>Region(s) of Distribution:</strong> ${f["Region(s) of Distribution"]}</p>
        <p><strong>Blooming Season:</strong> ${f["Blooming Season"]}</p>
        <p><strong>Peak Flowering Months:</strong> ${f["Peak Flowering Months"] || "N/A"}</p>
        <p><strong>Fruiting Period:</strong> ${f["Fruiting Period"] || "N/A"}</p>
        <p><strong>Pollinators / Notes:</strong> ${f["Pollinators / Notes"] || "N/A"}</p>
        <p><strong>Plant Type:</strong> ${f["Plant Type"] || "N/A"}</p>
        <p><strong>Stem Type:</strong> ${f["Stem Type"] || "N/A"}</p>
        <p><strong>Latitude:</strong> ${f.Latitude}</p>
        <p><strong>Longitude:</strong> ${f.Longitude}</p>
      `;
      sidePanel.style.display = "block";
    });

    // Optional: add Cesium OSM Buildings
    const buildingTileset = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(buildingTileset);

  </script>
</body>
</html>
